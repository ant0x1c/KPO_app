#### Участники проекта:
- Шевцов Антон (гр. 5130904/20103)

---

# Личный кабинет учёта расходов с курсами валют

Веб-приложение позволяет пользователям регистрироваться, добавлять свои расходы, 
фильтровать их по дате, просматривать сводку по годам и месяцам, 
а также видеть пересчитанные значения в выбранной валюте по историческому курсу с использованием внешнего API.

## Определение проблемы

Пользователям сложно отслеживать свои расходы с учётом валютных колебаний, 
отсутствует централизованный личный кабинет с возможностью фильтрации, 
статистики и анализа. Особенно неудобно это при ведении бюджета в нескольких валютах.

## Пользовательские сценарии

1. Когда мне не хватает средств, я хочу видеть список своих расходов, чтобы анализировать расходы и грамотнее планировать бюджет на будущее.
2. Когда мне трудно посчитать расходы в валюте, я хочу конвертировать расходы в нужную мне валюту, чтобы понять их реальную стоимость на момент траты.
3. Когда мне нужно анализировать траты, я хочу видеть сводку по месяцам и годам, чтобы отслеживать свои финансовые привычки.

---

# Разработка архитектуры и детальное проектирование

## Оценка нагрузки

- Ожидаемое количество пользователей: 10 000 в сутки

- Срок хранения данных: не менее 5 лет

### Соотношение нагрузки R/W:

| Тип нагрузки   | Процент                                                        |
|----------------|----------------------------------------------------------------|
| Чтение (Read)  | ~80% (просмотр общей таблицы расходов, трат по месяцам, годам) |
| Запись (Write) | ~20% (добавление расходов, изменение, логи действий)           |

  Большинство запросов — это отображение расходов, фильтрация, конвертация и сводки.

### Объемы трафика

- 10 000 Пользователей × ~20 запросов = 200 000 запросов в день.
- Средний размер ответа JSON: 1–2 КБ.
- Итоговый трафик: 200–400 МБ/день.

### Пиковая нагрузка

- До 500 запросов в секунду в часы пик (вечером).

### Объём БД

| Тип данных           | Оценка размера           |
|----------------------|--------------------------|
| Расходы              | ~100 млн × 200 Б = 40 ГБ |
| Пользователи (в год) | 5 млн × 100 Б = 500 МБ   |

Итого за 5 лет: примерно 50 ГБ (с запасом)

---

## Диаграммы архитектуры

### C1 - Context
![C1](/images/C1_diag.png)

### C2 - Container
![C2](/images/C2_diag.png)

---

## Контракты API

| Команда                                  | Описание                            | Вход                                                     | Выход                                                                                 |
|------------------------------------------|-------------------------------------|----------------------------------------------------------|---------------------------------------------------------------------------------------|
| `GET /expenses/list`                     | Просмотр всех расходов              | (опц.) `currency`, `dateFrom`, `dateTo`, `year`, `month` | HTML-страница со списком расходов                                                     |
| `POST /expenses/add`                     | Добавление нового расхода           | `title`, `amount`, `currency`, `date`                    | Редирект + сообщение об успехе                                                        |
| `POST /expenses/updateAll`               | Массовое редактирование расходов    | Массив id + изменённые поля                              | Редирект + сообщение об успехе                                                        |
| `POST /expenses/deleteSelected`          | Удаление выбранных расходов         | Список id                                                | Редирект + сообщение об успехе                                                        |
| `GET /expenses/summary`                  | Сводка по годам                     | —                                                        | HTML-страница с таблицей                                                              |
| `GET /expenses/summary/year/{year}`      | Сводка по месяцам выбранного года   | `year`                                                   | HTML-страница с таблицей                                                              |
| `GET /register` / `POST /users/register` | Регистрация пользователя            | `username`, `email`, `password`                          | Форма / подтверждение регистрации                                                     |
| `GET /login` / `POST /login`             | Аутентификация пользователя         | `username`, `password`                                   | Редирект на `/expenses/list` или alert (о неправильном имени пользователя или пароле) |
| `POST /logout`                           | Выход из системы                    | —                                                        | Редирект на `/login`                                                                  |
| API-запрос (внутренний)                  | Получение курса валют с Frankfurter | `https://api.frankfurter.app/{date}?from=XXX&to=YYY`     | Курс валют в формате JSON                                                             |

## Ожидаемые нефункциональные требования на время отклика

| Операция                                                    | Ожидаемое время отклика   | Примечание                                                    |
|-------------------------------------------------------------|---------------------------|---------------------------------------------------------------|
| Загрузка страницы со списком расходов (`/expenses/list`)    | ≤ **1 сек**               | При стандартной выборке без фильтрации                        |
| Загрузка страницы со сводкой по годам (`/expenses/summary`) | ≤ **1.5 сек**             | Для агрегированных данных по годам                            |
| Добавление нового расхода (`/expenses/add`)                 | ≤ **0.5 сек**             | После отправки формы — быстрая запись в БД                    |
| Массовое редактирование (`/expenses/updateAll`)             | ≤ **1.5 сек**             | До 20 записей за раз                                          |
| Удаление нескольких записей (`/expenses/deleteSelected`)    | ≤ **1.5 сек**             | С подтверждением                                              |
| Запрос к внешнему API Frankfurter (курс валют)              | ≤ **2.0 сек**             | Используется кэширование для одинаковых запросов              |
| Первичный вход пользователя (`/login`)                      | ≤ **1.0 сек**             | После авторизации — редирект к `/expenses/list`               |
| Регистрация пользователя (`/users/register`)                | ≤ **1.0 сек**             | Создание нового пользователя и хэширование пароля             |
| Время загрузки любой страницы интерфейса (HTML + CSS + JS)  | ≤ **800 мс** (на клиенте) | При обычной скорости сети, благодаря Bootstrap и лёгкому HTML |

---

## Схема базы данных

![DB](/images/db_schema.png)

**Таблицы:**
1. `users` — хранит данные пользователей
2. `expenses` — хранит расходы с указанием названия, валюты, суммы, даты и связи с пользователем

## Почему схема выдержит нефункциональные требования

| Аргумент                                  | Обоснование                                                                     |
|-------------------------------------------|---------------------------------------------------------------------------------|
| **Простая структура таблиц**              | Таблица `expenses` содержит только базовые типы (`id`, `amount`, `date` и т.д.) |
| **Оптимизированные запросы**              | Используются только `SELECT`, `WHERE`, `GROUP BY`, `ORDER BY`                   |
| **Отсутствие сложных JOIN'ов**            | Запросы используют только одну таблицу расходов (иногда — пользователя)         |
| **Проверено в тестировании**              | Запросы выполняются ≤ 1 сек при типичном объёме и фильтрации                    |

---

## Схема масштабирования при росте нагрузки в 10 раз

- Горизонтальное масштабирование приложения: запуск нескольких копий сервиса в Docker-контейнерах или на разных серверах (например, с помощью kubernetes).
- Использование балансировщика нагрузки (Load Balancer) для равномерного распределения запросов (также можно использовать kubernetes).
- Масштабирование базы данных с помощью репликации и шардинга.
- Кэширование часто исопльзуемых запросов

---

## Кодирование и отладка

### Коммиты в репозиторий:

![tests](/images/commits.png)

---

## Unit-тестирование

### Запросы к внешнему API:
* returnsOneWhenSameCurrency() - Проверяет возврат коэффициента обмена валюты 1 в случае совпадения исходной и конечной валюты (в базе его нет).
* returnsNullOnFailureOrInvalidDate() - Проверяет возврат null при отсутствии информации о курсе валют на выбранную дату.

### Тест регистрации нового пользователя:
* testRegisterUser() - Проверяет успешную регистрацию пользователя в приложении.

### Тест фильтров в таблице расходов:
* testFindByUserAndDateRange() - Проверяет успешную фильтрацию расходов по датам ("от" и "до").
* testFindByUserWithoutDateRange() - Проверяет отсутствие ошибок при фильтрации без выбранных дат.

## Интеграционные тесты

### Cценарий работы пользователя (fullExpenseFlow(), первый пользовательский сценарий):
1) Регистрация пользователя.
2) Вход в личный кабинет.
3) Добавление траты в список расходов.
4) Получение списка расходов.

![tests](/images/tests.png)

---

## Сборка и запуск

### 1. Запустить контейнер с приложением
```
docker compose up --build
```

---

### 2. Запустить тесты

Для запуска тестов после запуска основного приложения нужно зайти в контейнер и выполнить команду:
```
./mvnw test
```